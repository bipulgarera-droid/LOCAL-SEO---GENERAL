"""
Add this endpoint to api/index.py to download re-encoded images
"""

@app.route('/api/download-image', methods=['GET'])
def download_image():
    """
    Download an image with PIL re-encoding to ensure valid JPEG format.
    This fixes corrupt images generated before the PIL fix.
    """
    image_url = request.args.get('url')
    if not image_url:
        return jsonify({"error": "url parameter required"}), 400
    
    try:
        import requests as req
        import tempfile
        from PIL import Image
        import io
        
        # Download the image
        print(f"Downloading image for re-encoding: {image_url}", flush=True)
        response = req.get(image_url, timeout=30)
        response.raise_for_status()
        
        # Load and re-encode with PIL
        img = Image.open(io.BytesIO(response.content))
        
        # Convert to RGB if needed
        if img.mode != 'RGB':
            img = img.convert('RGB')
        
        # Save to bytes buffer
        buffer = io.BytesIO()
        img.save(buffer, 'JPEG', quality=95, optimize=True)
        buffer.seek(0)
        
        # Generate filename from URL or default
        import os
        from urllib.parse import urlparse
        parsed = urlparse(image_url)
        filename = os.path.basename(parsed.path) or 'image.jpg'
        if not filename.endswith('.jpg'):
            filename = filename.rsplit('.', 1)[0] + '.jpg'
        
        # Return as download
        from flask import send_file
        return send_file(
            buffer,
            mimetype='image/jpeg',
            as_attachment=True,
            download_name=filename
        )
        
    except Exception as e:
        print(f"Error downloading image: {e}", flush=True)
        return jsonify({"error": str(e)}), 500
