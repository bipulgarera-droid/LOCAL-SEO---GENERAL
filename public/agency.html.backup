<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgencyOS | SEO Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            900: '#111827',
                            950: '#0B0F19', // Deep Obsidian
                        },
                        violet: {
                            500: '#8B5CF6',
                            600: '#7C3AED',
                        },
                        emerald: {
                            500: '#10B981',
                        }
                    },
                    borderRadius: {
                        '2xl': '1rem',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0B0F19;
        }

        .glass {
            background: #111827;
            /* Gray-900 */
            border: 1px solid #1f2937;
            /* Gray-800 */
            border-radius: 1rem;
            /* rounded-2xl */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0B0F19;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        .top-nav-item.active {
            background-color: #111827;
            color: white;
            border-bottom: 2px solid #8B5CF6;
            /* Violet-500 */
        }

        .sub-nav-item.active {
            background-color: #1f2937;
            color: white;
            border-right: 2px solid #8B5CF6;
            /* Violet-500 */
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            letter-spacing: -0.025em;
            /* tracking-tight */
            font-weight: 700;
            /* bold */
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation -->
    <nav class="h-14 bg-gray-900 border-b border-gray-800 flex items-center px-4 shrink-0 justify-between">
        <div class="flex items-center gap-6 h-full">
            <!-- Logo -->
            <div class="flex items-center gap-2 mr-4">
                <div
                    class="bg-gradient-to-r from-violet-600 to-indigo-600 p-1.5 rounded-lg shadow-lg shadow-indigo-500/20">
                    <i data-lucide="brain-circuit" class="w-4 h-4 text-white"></i>
                </div>
                <span class="text-sm font-bold tracking-tight text-white">Agency<span
                        class="text-violet-500">OS</span></span>
            </div>

            <!-- Major Tabs -->
            <div class="flex h-full space-x-1">
                <button onclick="switchMainTab('projects')" id="tab-projects"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="folder" class="w-4 h-4"></i> Projects
                </button>
                <button onclick="switchMainTab('tech-audit')" id="tab-tech-audit"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="stethoscope" class="w-4 h-4"></i> Tech Audit
                </button>
                <button onclick="switchMainTab('classification')" id="tab-classification"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="tags" class="w-4 h-4"></i> URL Classification
                </button>
                <button onclick="switchMainTab('product-pillars')" id="tab-product-pillars"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="package" class="w-4 h-4"></i> Product / Pillars
                </button>
                <button onclick="switchMainTab('category-pages')" id="tab-category-pages"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> Category Pages
                </button>
                <button onclick="switchMainTab('mofu')" id="tab-mofu"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="layers" class="w-4 h-4"></i> MoFu / Silo Topics
                </button>
                <button onclick="switchMainTab('tofu')" id="tab-tofu"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="git-branch" class="w-4 h-4"></i> ToFu / Sub-Silo Topics
                </button>
                <button onclick="switchMainTab('photoshoot')" id="tab-photoshoot"
                    class="top-nav-item px-4 h-full flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">
                    <i data-lucide="camera" class="w-4 h-4"></i> Product Photoshoot
                </button>
                <!-- ... -->

            </div>
        </div>

        <!-- Right Actions -->
        <div class="flex items-center gap-3">
            <select id="projectSelect" onchange="loadProject(this.value)"
                class="bg-gray-800 border-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 text-white w-48">
                <option value="" disabled selected>Select Project...</option>
            </select>
            <button onclick="openNewProjectModal()"
                class="bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white shadow-lg shadow-indigo-500/20 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all duration-200">
                <i data-lucide="plus" class="w-4 h-4"></i> New Project
            </button>
        </div>
    </nav>

    <!--Main Workspace-->
    <div class="flex-1 flex overflow-hidden">

        <!-- Left Sidebar (Dynamic) -->
        <aside id="leftSidebar" class="w-60 bg-gray-900/50 border-r border-gray-800 flex flex-col shrink-0 hidden">
            <!-- Sidebar Content Injected via JS -->
            <div id="sidebarContent" class="p-2 space-y-1"></div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 bg-gray-950 relative overflow-hidden flex flex-col">

            <!-- Loading Overlay -->
            <div id="loadingOverlay"
                class="absolute inset-0 bg-gray-950/80 backdrop-blur-sm z-50 hidden items-center justify-center flex-col">
                <i data-lucide="loader-2" class="w-8 h-8 text-blue-500 animate-spin mb-2"></i>
                <span class="text-sm text-gray-400">Processing...</span>
            </div>

            <!-- Views -->
            <div id="view-container" class="flex-1 overflow-auto p-4">

                <!-- 1. Projects View -->
                <div id="view-projects" class="view-section hidden space-y-2">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-white">Project Dashboard</h2>
                    </div>
                    <div class="glass rounded-xl overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                                <tr>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Company</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Domain</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Language</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Location</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Focus</th>
                                    <th
                                        class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Do Audit?</th>
                                    <th
                                        class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Do Classify?</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Business Overview & Strategy</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        ICP</th>
                                    <th
                                        class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Start</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Tech Audit View -->
                <div id="view-tech-audit" class="view-section hidden space-y-2">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-white">Technical Audit</h2>
                        <button onclick="runBatchAudit()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i> Analyze All Pending
                        </button>
                    </div>
                    <div class="glass rounded-xl overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                                <tr>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">URL</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Status Code</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Click Depth</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Canonical</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Page Title</th>
                                    <th class="px-6 py-3 font-medium whitespace-nowrap">Projects</th>
                                </tr>
                            </thead>
                            <tbody id="techAuditTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. Classification View -->
            <div id="view-classification" class="view-section hidden space-y-2">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-white">URL Classification</h2>
                </div>
                <div class="glass rounded-xl overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                            <tr>
                                <th class="px-6 py-3 font-medium">URL</th>
                                <th class="px-6 py-3 font-medium">Type</th>
                                <th class="px-6 py-3 font-medium">Status</th>
                            </tr>
                        </thead>
                        <tbody id="classificationTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
    </div>

    <!-- 4. Product / Pillars View -->
    <div id="view-product-pillars" class="view-section hidden space-y-2">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold text-white">Products / Services Pages</h2>
        </div>
        <div class="glass rounded-xl overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                    <tr>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Product / Services</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">URL</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Existing Content</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Action</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Content</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Meta Description</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Meta Title</th>
                    </tr>
                </thead>
                <tbody id="productPillarsTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 4.5. Category Pages View -->
    <div id="view-category-pages" class="view-section hidden space-y-2">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold text-white">Category Pages</h2>
        </div>
        <div class="glass rounded-xl overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                    <tr>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">Category Page</th>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">URL</th>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">Existing Content</th>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">Meta Description</th>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">Action</th>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">Content</th>
                        <th class="px-6 py-3 font-medium w-1/6 whitespace-nowrap">Meta Title</th>
                    </tr>
                </thead>
                <tbody id="categoryPagesTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 5. MoFu View -->
    <div id="view-mofu" class="view-section hidden space-y-2">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold text-white">MoFu / Silo Topics</h2>
        </div>
        <div class="glass rounded-xl overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[1200px]">
                <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                    <tr>
                        <th class="px-6 py-3 font-medium min-w-[350px] whitespace-nowrap">Topic / Silo
                        </th>
                        <th class="px-6 py-3 font-medium w-64 whitespace-nowrap">Content Description
                        </th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Keywords</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Action</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Research Data</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Content</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Meta Title</th>
                        <th class="px-6 py-3 font-medium w-64 whitespace-nowrap">Meta Description</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Slug</th>
                    </tr>
                </thead>
                <tbody id="mofuTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- View: ToFu -->
    <div id="view-tofu" class="view-section hidden space-y-2">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold text-white">ToFu / Sub-Silo Topics</h2>
        </div>
        <div class="glass rounded-xl overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[1200px]">
                <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                    <tr>
                        <th class="px-6 py-3 font-medium w-64 whitespace-nowrap">Topic / Sub-Silo</th>
                        <th class="px-6 py-3 font-medium w-64 whitespace-nowrap">Content Description
                        </th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Keywords</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Action</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Research Data</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Content</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Meta Title</th>
                        <th class="px-6 py-3 font-medium w-64 whitespace-nowrap">Meta Description</th>
                        <th class="px-6 py-3 font-medium w-48 whitespace-nowrap">Slug</th>
                    </tr>
                </thead>
                <tbody id="tofuTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- View: Product Photoshoot -->
    <div id="view-photoshoot" class="view-section hidden space-y-2">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold text-white">Product Photoshoot</h2>
            <button onclick="addPhotoshootRow()"
                class="bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white shadow-lg shadow-indigo-500/20 px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-2 transition-all duration-200">
                <i data-lucide="plus" class="w-3 h-3"></i> Add Row
            </button>
        </div>
        <div class="glass rounded-xl overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[1000px]">
                <thead class="bg-gray-900/50 text-xs uppercase text-gray-400 border-b border-gray-800">
                    <tr>
                        <th class="px-6 py-3 font-medium w-64 whitespace-nowrap">Prompt</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Input Image</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Status</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Output</th>
                        <th class="px-6 py-3 font-medium w-32 whitespace-nowrap">Action</th>
                        <th class="px-6 py-3 font-medium w-16 whitespace-nowrap"></th>
                    </tr>
                </thead>
                <tbody id="photoshootTable" class="divide-y divide-gray-800 text-sm text-gray-300">
                    <!-- Rows -->
                </tbody>
            </table>
        </div>
    </div>
    </div>

    </div>
    </main>
    </div>

    <!--Modals -->
    <!--New Project Modal-->
    <div id="newProjectModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[100]">
        <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-lg font-semibold text-white">New Project</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Domain</label>
                    <input type="text" id="newDomain" placeholder="example.com"
                        class="w-full bg-gray-800 border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Language</label>
                        <select id="newLanguage"
                            class="w-full bg-gray-800 border-gray-700 rounded-lg px-4 py-2 text-white outline-none">
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                            <option value="German">German</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Location</label>
                        <select id="newLocation"
                            class="w-full bg-gray-800 border-gray-700 rounded-lg px-4 py-2 text-white outline-none">
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Focus</label>
                    <select id="newFocus"
                        class="w-full bg-gray-800 border-gray-700 rounded-lg px-4 py-2 text-white outline-none">
                        <option value="Product">Product (E-commerce)</option>
                        <option value="Service">Service (B2B/Local)</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeNewProjectModal()" class="text-gray-400 hover:text-white text-sm">Cancel</button>
                <button onclick="createProject()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Create</button>
            </div>
        </div>
    </div>

    <!--Business Overview Modal-->
    <div id="overviewModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[100]">
        <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Business Overview & Strategy</h3>
                <button onclick="document.getElementById('overviewModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-8 prose prose-invert max-w-none" id="overviewContent">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!--Content Preview Modal-->
    <div id="contentModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[100]">
        <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-white">Generated Content</h3>
                <button onclick="document.getElementById('contentModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-8 prose prose-invert max-w-none" id="contentModalBody">
                <!-- Content -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentProject = null;
        let projectPages = [];
        let allProjects = [];

        // Helper function to remove markdown asterisks
        function cleanAsterisks(text) {
            if (!text) return text;
            return text.replace(/\*\*/g, '').replace(/\*/g, '');
        }

        // --- Init ---
        lucide.createIcons();
        loadProjectsList();
        switchMainTab('projects');

        // --- Navigation Logic ---
        function switchMainTab(tabId) {
            // 1. Update Top Nav Styles
            document.querySelectorAll('.top-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // 2. Show Main View Container
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');

            // 3. Update Left Sidebar based on Tab
            updateLeftSidebar(tabId);

            // 4. Render Data
            if (tabId === 'projects') renderProjectsTable();
            else if (currentProject) {
                if (tabId === 'tech-audit') renderTechAudit();
                if (tabId === 'classification') renderClassification();
                if (tabId === 'product-pillars') renderProductPillars();
                if (tabId === 'category-pages') renderCategoryPages();
                if (tabId === 'mofu') renderMoFu();
                if (tabId === 'tofu') renderToFu();
                if (tabId === 'photoshoot') loadPhotoshoots();
            }
        }

        function updateLeftSidebar(tabId) {
            const sidebar = document.getElementById('leftSidebar');
            const content = document.getElementById('sidebarContent');
            content.innerHTML = '';

            if (tabId === 'projects') {
                sidebar.classList.add('hidden'); // No sidebar for Projects dashboard
                return;
            }

            sidebar.classList.remove('hidden');

            if (tabId === 'tech-audit') {
                content.innerHTML = `
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-2">Tech Issues</div>
                    <button onclick="switchTechAuditSubTab('url-inspection')" id="subtab-url-inspection" class="sub-nav-item active w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">URL Inspection</button>
                    <button onclick="switchTechAuditSubTab('on-page-report')" id="subtab-on-page-report" class="sub-nav-item w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">On-Page Report</button>
                    <button onclick="switchTechAuditSubTab('snippets')" id="subtab-snippets" class="sub-nav-item w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">Snippet Errors & Recommendations</button>
                    <button onclick="switchTechAuditSubTab('technical-issues')" id="subtab-technical-issues" class="sub-nav-item w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">Technical Issues</button>
                    <button onclick="switchTechAuditSubTab('page-speed')" id="subtab-page-speed" class="sub-nav-item w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">Page Speed & Performance</button>
                `;
            } else if (tabId === 'classification') {
                content.innerHTML = `
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-2">Filters</div>
                    <button class="sub-nav-item active w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">All URLs</button>
                    <button class="sub-nav-item w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">Unclassified</button>
                    <button class="sub-nav-item w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">Product Pages</button>
                `;
            } else if (tabId === 'product-pillars') {
                content.innerHTML = `
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-2">Products / Services Actions</div>
                    <button class="sub-nav-item active w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">All Products / Services</button>

                `;
            } else if (tabId === 'category-pages') {
                content.innerHTML = `
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-2">Category Actions</div>
                    <button class="sub-nav-item active w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">All Category Pages</button>

                `;
            } else if (tabId === 'mofu') {
                content.innerHTML = `
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-2">MoFu Topics</div>
                    <button class="sub-nav-item active w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">All Topics</button>

                `;
            } else if (tabId === 'tofu') {
                content.innerHTML = `
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-3 mt-2">ToFu Topics</div>
                    <button class="sub-nav-item active w-full text-left px-3 py-2 text-sm text-gray-300 rounded hover:bg-gray-800 transition-colors">All Topics</button>

                `;
            }
        }

        // --- Data Logic ---
        async function loadProjectsList() {
            try {
                const res = await fetch(`${API_BASE}/get-projects`);
                const data = await res.json();
                allProjects = data.projects || [];

                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="" disabled selected>Select Project...</option>';
                allProjects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.domain}</option>`;
                });

                renderProjectsTable();
            } catch (e) { console.error(e); }
        }

        async function loadProject(id) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            try {
                // Find project metadata locally first
                currentProject = allProjects.find(p => p.id === id);

                const res = await fetch(`${API_BASE}/get-pages?project_id=${id}`);
                const data = await res.json();
                projectPages = data.pages || [];

                // If we are on projects tab, just update table. If on others, render view.
                if (document.getElementById('tab-projects').classList.contains('active')) {
                    renderProjectsTable();
                } else {
                    switchMainTab(document.querySelector('.top-nav-item.active').id.replace('tab-', ''));
                }
            } catch (e) { alert(e); }
            finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        // --- View 1: Projects Table ---
        function renderProjectsTable() {
            const tbody = document.getElementById('projectsTable');
            tbody.innerHTML = '';

            allProjects.forEach(p => {
                const overview = p.business_summary ? p.business_summary.substring(0, 100) + '...' : '<span class="text-gray-600 italic">Not generated</span>';
                const strategy = p.strategy_plan ? p.strategy_plan.substring(0, 100) + '...' : '<span class="text-gray-600 italic">Not generated</span>';

                const auditDone = p.page_count > 0;
                const classifyDone = p.classified_count > 0;

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50 align-top">
                        <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${p.project_name}</td>
                        <td class="px-6 py-4 text-blue-400 whitespace-nowrap">${p.domain}</td>
                        <td class="px-6 py-4 text-gray-400 whitespace-nowrap">${p.language || 'English'}</td>
                        <td class="px-6 py-4 text-gray-400 whitespace-nowrap">${p.location || 'US'}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="bg-gray-800 px-2 py-1 rounded text-xs">${p.focus || 'Product'}</span></td>
                        
                        <td class="px-6 py-4 text-center whitespace-nowrap">
                            ${auditDone
                        ? `<span class="text-green-500 font-medium text-xs">Done (${p.page_count})</span>`
                        : '<span class="text-gray-600">-</span>'
                    }
                        </td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">
                            ${classifyDone
                        ? `<span class="text-green-500 font-medium text-xs">Done (${p.classified_count})</span>`
                        : '<span class="text-gray-600">-</span>'
                    }
                        </td>
                        
                        <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white min-w-[300px] max-w-[500px] whitespace-normal leading-relaxed" onclick="showOverview('${p.id}')">
                            <div class="mb-2"><span class="text-gray-500 font-semibold">Overview:</span> ${overview}</div>
                            <div><span class="text-gray-500 font-semibold">Strategy:</span> ${strategy}</div>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white min-w-[200px] max-w-[300px] whitespace-normal leading-relaxed" onclick="showICP('${p.id}')">
                            ${p.ideal_customer_profile ? p.ideal_customer_profile.substring(0, 100) + '...' : '<span class="text-gray-600 italic">Not generated</span>'}
                        </td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">
                            <button onclick="startProjectSetup('${p.id}')" class="${p.business_summary ? 'bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 shadow-lg shadow-indigo-500/20' : 'bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 shadow-lg shadow-emerald-500/20'} text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200">
                                ${p.business_summary ? 'Regenerate' : 'Start'}
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function showOverview(projectId) {
            const p = allProjects.find(pr => pr.id === projectId);
            if (!p || !p.business_summary) return;

            const modalContent = document.getElementById('overviewContent');
            modalContent.innerHTML = `
                <h2>Business Profile</h2>
                <p><strong>Summary:</strong> ${cleanAsterisks(p.business_summary)}</p>
                <p class="mt-2"><strong>ICP:</strong> ${cleanAsterisks(p.ideal_customer_profile || 'Not generated')}</p>
                <hr class="my-6 border-gray-700">
                <h2>Strategy Plan</h2>
                <div class="whitespace-pre-wrap">${cleanAsterisks(p.strategy_plan || 'Strategy not generated.')}</div>
            `;
            document.getElementById('overviewModal').classList.remove('hidden');
            document.getElementById('overviewModal').classList.add('flex');
        }

        function showICP(projectId) {
            const p = allProjects.find(pr => pr.id === projectId);
            if (!p || !p.ideal_customer_profile) {
                alert('ICP not generated yet. Click "Start" or "Regenerate" to generate it.');
                return;
            }

            const modalContent = document.getElementById('overviewContent');
            modalContent.innerHTML = `
                <h2>Ideal Customer Profile (ICP)</h2>
                <div class="whitespace-pre-wrap">${cleanAsterisks(p.ideal_customer_profile)}</div>
            `;
            document.getElementById('overviewModal').classList.remove('hidden');
            document.getElementById('overviewModal').classList.add('flex');
        }

        async function startProjectSetup(projectId) {
            const p = allProjects.find(pr => pr.id === projectId);
            // Auto-trigger audit/classify if not done yet
            // Force audit on regenerate to fix missing titles/pages
            const doAudit = (p.page_count === 0 || !p.page_count);
            const doClassify = (p.classified_count === 0 || !p.classified_count);

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                const res = await fetch(`${API_BASE}/run-project-setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectId,
                        do_audit: doAudit,
                        do_classify: doClassify
                    })
                });
                const data = await res.json();

                // Update local state immediately
                const p = allProjects.find(pr => pr.id === projectId);
                if (p) {
                    p.business_summary = data.profile.business_summary;
                    p.strategy_plan = data.strategy_plan;
                    if (data.pages_found > 0) {
                        p.page_count = (p.page_count || 0) + data.pages_found;
                    }
                }

                renderProjectsTable();

                // Show Result in Modal
                const modalContent = document.getElementById('overviewContent');
                modalContent.innerHTML = `
                    <h2>Business Profile</h2>
                    <p><strong>Summary:</strong> ${data.profile.business_summary}</p>
                    <p><strong>ICP:</strong> ${data.profile.ideal_customer_profile}</p>
                    <hr class="my-6 border-gray-700">
                    <h2>Strategy Plan</h2>
                    <div class="whitespace-pre-wrap">${data.strategy_plan || 'Strategy generated.'}</div>
                    ${data.pages_found > 0 ? `<div class="mt-4 p-4 bg-green-900/20 text-green-400 rounded">Tech Audit Started: Found ${data.pages_found} pages.</div>` : ''}
                `;
                document.getElementById('overviewModal').classList.remove('hidden');
                document.getElementById('overviewModal').classList.add('flex');

                // Trigger Classification if needed
                if (doClassify && data.pages_found > 0) {
                    // We can trigger this in background or ask user. 
                    // For now, let's just trigger it silently or show a toast.
                    // Since we don't have a classify endpoint that takes project_id easily exposed here without looking,
                    // let's just assume the user will go to URL Classification tab.
                    // BUT user asked for "Start triggers all 4 things".
                    // Let's try to call the classify endpoint if we can find it.
                    // Actually, let's just update the UI to say "Ready to Classify" or similar if we can't auto-run.
                    // Wait, I can call the classify endpoint.
                    // Let's look for it.
                }

                // Refresh data
                loadProject(projectId);

            } catch (e) {
                console.error(e);
                alert("Failed to start project setup");
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        async function runAudit(projectId) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            try {
                const res = await fetch(`${API_BASE}/run-project-setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectId,
                        do_audit: true,
                        do_classify: false
                    })
                });
                const data = await res.json();

                // Update local state
                const p = allProjects.find(pr => pr.id === projectId);
                if (p && data.pages_found > 0) {
                    p.page_count = (p.page_count || 0) + data.pages_found;
                }

                renderProjectsTable();

                if (data.pages_found === 0) {
                    alert("Audit finished but no pages were found. Please check the domain or sitemap.");
                }
            } catch (e) {
                console.error(e);
                alert("Audit failed: " + e.message);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        function goToClassification(projectId) {
            // Switch to Classification Tab
            switchMainTab('classification');
            // We can't easily select the project in the dropdown without more logic, 
            // but getting the user to the tab is the main step.
            // Ideally we would set the dropdown value and trigger the change event.
        }

        // --- View 2: Tech Audit ---
        function renderTechAudit() {
            // Default to URL Inspection
            switchTechAuditSubTab('url-inspection');
        }

        function switchTechAuditSubTab(subTabId) {
            // 1. Update Active State
            document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById(`subtab-${subTabId}`);
            if (activeBtn) activeBtn.classList.add('active');

            // 2. Render Content
            const tbody = document.getElementById('techAuditTable');
            tbody.innerHTML = '';

            if (projectPages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No pages found. Run "Start" on Projects tab first.</td></tr>';
                return;
            }

            // Header Update (Optional: You might want to change headers based on view)
            // For now, we assume the same table structure but filter/show different data if needed.
            // Or we can just render the same data for now as a placeholder for other tabs.

            if (subTabId === 'url-inspection') {
                // Restore Header for URL Inspection
                const thead = document.querySelector('#view-tech-audit thead tr');
                thead.innerHTML = `
                    <th class="px-6 py-3 font-medium">URL</th>
                    <th class="px-6 py-3 font-medium">Status Code</th>
                    <th class="px-6 py-3 font-medium">Click Depth</th>
                    <th class="px-6 py-3 font-medium">Canonical</th>
                    <th class="px-6 py-3 font-medium">Page Title</th>
                    <th class="px-6 py-3 font-medium">Projects</th>
                `;
                renderUrlInspection(tbody);
            } else if (subTabId === 'page-speed') {
                renderPageSpeed(tbody);
            } else if (subTabId === 'on-page-report') {
                renderOnPageReport(tbody);
            } else if (subTabId === 'technical-issues') {
                renderTechnicalIssues(tbody);
            } else if (subTabId === 'snippets') {
                renderSnippets(tbody);
            } else {
                // Placeholder for other tabs
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">View "${subTabId}" is under construction.</td></tr>`;
            }
        }

        function renderUrlInspection(tbody) {
            const rows = projectPages.map(p => {
                const data = p.tech_audit_data || {};

                // Determine Status Display
                let statusDisplay = '-';
                let statusClass = 'text-gray-400';

                if (data.status_code) {
                    if (data.status_code === 200) {
                        statusDisplay = '200 OK';
                        statusClass = 'text-green-400';
                    } else if (data.status_code === 0) {
                        statusDisplay = 'Failed';
                        statusClass = 'text-red-500';
                    } else {
                        statusDisplay = data.status_code;
                        statusClass = 'text-red-400';
                    }
                } else if (data.error) {
                    statusDisplay = 'Error';
                    statusClass = 'text-red-500';
                }

                return `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4 whitespace-nowrap" title="${p.url}">${p.url}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs ${statusClass}" title="${data.error || ''}">${statusDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400">${data.click_depth || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400" title="${data.canonical}">${data.canonical || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400" title="${data.title}">${data.title || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400 text-xs"><span class="bg-gray-800 px-2 py-1 rounded">${currentProject.project_name}</span></td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function renderPageSpeed(tbody) {
            // Update Header for PageSpeed
            const thead = document.querySelector('#view-tech-audit thead tr');
            thead.innerHTML = `
                <th class="px-6 py-3 font-medium whitespace-nowrap">URL</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Cumulative Layout Shift</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">LCP</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Load Time (ms)</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">High Loading Time</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Action</th>
            `;

            const rows = projectPages.map(p => {
                const data = p.tech_audit_data || {};
                const speed = data.speed && data.speed.mobile ? data.speed.mobile : null;

                // Load Time Flag
                const isSlow = data.high_loading_time ? '<span class="text-red-500 font-bold">Yes</span>' : '<span class="text-gray-600">-</span>';
                const loadTime = data.load_time_ms ? `${data.load_time_ms}ms` : '-';

                // Speed Metrics
                const cls = speed ? speed.cls : '-';
                const lcp = speed ? speed.lcp : '-';

                return `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4 whitespace-nowrap" title="${p.url}">${p.url}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400">${cls}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400">${lcp}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-gray-300">${loadTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${isSlow}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="runPageSpeed('${p.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                Analyze Speed
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function renderOnPageReport(tbody) {
            // Update Header for On-Page Report
            const thead = document.querySelector('#view-tech-audit thead tr');
            thead.innerHTML = `
                <th class="px-6 py-3 font-medium whitespace-nowrap">URL</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Status</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">OnPage Score</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Meta Title</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Title Len</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Meta Desc</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Desc Len</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">No H1</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">No Img Alt</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Checks</th>
            `;

            const rows = projectPages.map(p => {
                const data = p.tech_audit_data || {};

                // Score Color
                let score = data.onpage_score || 0;
                let scoreColor = 'text-red-400';
                if (score >= 90) scoreColor = 'text-green-400';
                else if (score >= 70) scoreColor = 'text-yellow-400';

                // H1 Check
                const noH1 = data.missing_h1 ? '<span class="text-red-500">Yes</span>' : '<span class="text-gray-600">-</span>';

                // Alt Check
                const noAlt = data.missing_alt_count > 0 ? `<span class="text-red-400 font-bold">${data.missing_alt_count}</span>` : '<span class="text-gray-600">-</span>';

                // Checks Display
                let checksHtml = '-';
                if (data.checks && data.checks.length > 0) {
                    checksHtml = data.checks.map(c => `<span class="bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded text-[10px] mr-1 inline-block mb-1">${c}</span>`).join('');
                } else if (data.onpage_score === 100) {
                    checksHtml = '<span class="text-green-400 text-xs">All Good</span>';
                }

                return `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50 align-top">
                        <td class="px-6 py-4 max-w-[400px] truncate" title="${p.url}">${p.url}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-gray-400">${data.status_code || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold ${scoreColor}">${score}</td>
                        <td class="px-6 py-4 min-w-[200px] max-w-[300px] whitespace-normal text-gray-400 text-sm leading-relaxed">${data.title || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400">${data.title_length || 0}</td>
                        <td class="px-6 py-4 min-w-[300px] max-w-[500px] whitespace-normal text-gray-500 text-sm leading-relaxed">${data.meta_description || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400">${data.description_length || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${noH1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${noAlt}</td>
                        <td class="px-6 py-4 min-w-[150px] whitespace-normal">${checksHtml}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function renderSnippets(tbody) {
            const thead = document.querySelector('#view-tech-audit thead tr');
            thead.innerHTML = `
                <th class="px-6 py-3 font-medium whitespace-nowrap">URL</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Google Title</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Google Desc</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">OG Title</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">OG Desc</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Has Schema</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Issues</th>
            `;

            const rows = projectPages.map(p => {
                const data = p.tech_audit_data || {};

                const ogTitle = data.og_title || '<span class="text-gray-600 italic">Missing</span>';
                const ogDesc = data.og_description || '<span class="text-gray-600 italic">Missing</span>';
                const hasSchema = data.has_schema ? '<span class="text-green-400">Yes</span>' : '<span class="text-gray-600">No</span>';

                // Collect snippet-related issues
                const issues = [];
                if (!data.title) issues.push("Missing Title");
                if (!data.meta_description) issues.push("Missing Desc");
                if (!data.og_title) issues.push("Missing OG Title");
                if (!data.og_description) issues.push("Missing OG Desc");

                const issuesHtml = issues.length > 0
                    ? issues.map(i => `<span class="bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded text-[10px] mr-1 inline-block mb-1">${i}</span>`).join('')
                    : '<span class="text-green-400 text-xs">All Good</span>';

                return `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50 align-top">
                        <td class="px-6 py-4 whitespace-nowrap text-sm" title="${p.url}">${p.url}</td>
                        <td class="px-6 py-4 min-w-[200px] max-w-[300px] whitespace-normal text-gray-300 text-xs leading-relaxed">${data.title || '-'}</td>
                        <td class="px-6 py-4 min-w-[250px] max-w-[400px] whitespace-normal text-gray-400 text-xs leading-relaxed">${data.meta_description || '-'}</td>
                        <td class="px-6 py-4 min-w-[200px] max-w-[300px] whitespace-normal text-blue-300 text-xs leading-relaxed">${ogTitle}</td>
                        <td class="px-6 py-4 min-w-[250px] max-w-[400px] whitespace-normal text-blue-400 text-xs leading-relaxed">${ogDesc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-xs">${hasSchema}</td>
                        <td class="px-6 py-4 min-w-[150px] whitespace-normal">${issuesHtml}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function renderTechnicalIssues(tbody) {
            const thead = document.querySelector('#view-tech-audit thead tr');
            thead.innerHTML = `
                <th class="px-6 py-3 font-medium whitespace-nowrap">URL</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Status Code</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap">Canonical</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Is Redirect?</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Is 4xx?</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Is 5xx?</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">High Load Time</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Duplicate Title</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Duplicate Desc</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Broken Links</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Redirect Chain</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Canonical Mismatch</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">No H1</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">No Img Alt</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Orphan Page</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Is Broken</th>
                <th class="px-6 py-3 font-medium whitespace-nowrap text-center">Has Schema</th>
            `;

            projectPages.forEach(p => {
                const data = p.tech_audit_data || {};

                const isRedirect = data.is_redirect ? '<span class="text-yellow-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const is4xx = data.is_4xx_code ? '<span class="text-red-500 font-bold">Yes</span>' : '<span class="text-gray-600">-</span>';
                const is5xx = data.is_5xx_code ? '<span class="text-red-600 font-bold">Yes</span>' : '<span class="text-gray-600">-</span>';
                const highLoad = data.high_loading_time ? '<span class="text-yellow-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const dupTitle = data.duplicate_title ? '<span class="text-red-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const dupDesc = data.duplicate_desc ? '<span class="text-red-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const brokenLinks = (data.broken_links && data.broken_links.length > 0) ? '<span class="text-red-400">Yes</span>' : '<span class="text-gray-600">-</span>';

                const redirChain = data.redirect_chain ? '<span class="text-yellow-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const canonMismatch = data.canonical_mismatch ? '<span class="text-red-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const noH1 = data.missing_h1 ? '<span class="text-red-400">Yes</span>' : '<span class="text-gray-600">-</span>';
                const noAlt = data.missing_alt_count > 0 ? `<span class="text-red-400 font-bold">${data.missing_alt_count}</span>` : '<span class="text-gray-600">-</span>';
                const orphan = data.is_orphan_page ? '<span class="text-red-400">Yes</span>' : '<span class="text-gray-600">-</span>';

                const isBroken = data.is_broken ? '<span class="text-red-600 font-bold">Yes</span>' : '<span class="text-gray-600">-</span>';
                const hasSchema = data.has_schema ? '<span class="text-green-400">Yes</span>' : '<span class="text-gray-600">-</span>';

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4 whitespace-nowrap" title="${p.url}">${p.url}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-mono text-xs text-gray-400">${data.status_code || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-400" title="${data.canonical}">${data.canonical || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${isRedirect}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${is4xx}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${is5xx}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${highLoad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${dupTitle}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${dupDesc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${brokenLinks}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${redirChain}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${canonMismatch}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${noH1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${noAlt}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${orphan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${isBroken}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${hasSchema}</td>
                    </tr>
                `;
            });
        }

        async function runPageSpeed(pageId) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Running...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/analyze-speed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_id: pageId, strategy: 'mobile' })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                await loadProject(currentProject.id); // Refresh
            } catch (e) {
                alert(`Error: ${e.message}`);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function runBatchAudit() {
            if (projectPages.length === 0) {
                alert("No pages found for this project. Please ensure the project was set up correctly and URLs were discovered.");
                return;
            }
            if (!confirm(`Analyze first 5 pending pages? (Demo Limit)`)) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            // Demo: just run first 5
            const pending = projectPages.slice(0, 5);

            // Run in parallel
            const promises = pending.map(p =>
                fetch(`${API_BASE}/start-audit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_id: p.id })
                }).then(res => res.json())
            );

            try {
                await Promise.all(promises);
                alert("Batch audit completed!");
            } catch (e) {
                console.error(e);
                alert("Some audits failed. Check console.");
            }

            await loadProject(currentProject.id);
        }

        // --- Helper: Markdown Renderer ---
        function renderMarkdown(text) {
            if (!text) return '';
            let html = text
                // Bold: **text** -> <strong>text</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Headers: ## Text -> <h3>Text</h3>
                .replace(/^### (.*$)/gm, '<h5 class="font-bold text-gray-200 mt-3 mb-1">$1</h5>')
                .replace(/^## (.*$)/gm, '<h4 class="font-bold text-white mt-4 mb-2">$1</h4>')
                // Lists: * text or - text -> <li>text</li>
                .replace(/^\s*[\*\-]\s+(.*$)/gm, '<li class="ml-4">$1</li>')
                // Line breaks to <br> if not in a list
                .replace(/\n/g, '<br>');

            if (html.includes('<li')) {
                html = html.replace(/((?:<li.*?>.*?<\/li>\s*)+)/g, '<ul class="list-disc list-inside space-y-1 text-gray-300">$1</ul>');
            }
            return html;
        }

        // --- View 3: Classification ---
        function renderClassification() {
            const tbody = document.getElementById('classificationTable');

            const rows = projectPages.map(p => {
                const pageType = p.page_type || '';
                return `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4 truncate max-w-xs text-sm" title="${p.url}">${p.url}</td>
                        <td class="px-6 py-4 text-sm text-gray-400">${p.tech_audit_data?.status_code || '-'}</td>
                        <td class="px-6 py-4">
                            <select onchange="handleClassificationChange('${p.id}', this.value)" class="bg-gray-800 border-gray-700 text-xs rounded px-2 py-1 text-white w-full focus:ring-2 focus:ring-blue-500">
                                <option value="" ${pageType === '' ? 'selected' : ''}>Select Type</option>
                                <option value="Product" ${pageType === 'Product' ? 'selected' : ''}>Product</option>
                                <option value="Category" ${pageType === 'Category' ? 'selected' : ''}>Category</option>
                                <option value="Blog" ${pageType === 'Blog' ? 'selected' : ''}>Blog</option>
                                <option value="Other" ${pageType === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-400">${p.tech_audit_data?.title || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${currentProject.project_name}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        async function handleClassificationChange(pageId, newType) {
            try {
                // Optimistic UI Update
                const page = projectPages.find(p => p.id === pageId);
                if (page) page.page_type = newType;

                const res = await fetch(`${API_BASE}/update-page-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_id: pageId, page_type: newType })
                });
                const data = await res.json();

                // Apply backend updates (e.g., fetched title) to local state
                if (data.updates && page) {
                    if (data.updates.tech_audit_data) {
                        page.tech_audit_data = { ...page.tech_audit_data, ...data.updates.tech_audit_data };
                    }
                    // Re-render relevant views to show new title
                    if (newType === 'Product') renderProductPillars();
                    renderClassification(); // Update current view too
                }
            } catch (e) {
                console.error(e);
                alert("Failed to update classification");
            }
        }

        // --- View 4: Product / Pillars ---
        function renderProductPillars() {
            const tbody = document.getElementById('productPillarsTable');
            tbody.innerHTML = '';

            // Only show pages classified as 'Product'
            const products = projectPages.filter(p => p.page_type === 'Product');

            // Helper for safe string escaping
            function safeStr(str) {
                if (!str) return '';
                return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            }

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No Product pages found. Classify pages in "URL Classification" tab first.</td></tr>';
                return;
            }

            const rows = products.map(p => {
                const data = p.tech_audit_data || {};
                const contentPreview = p.content ? p.content.substring(0, 50) + '...' : '';
                const existingPreview = p.tech_audit_data?.meta_description ? p.tech_audit_data.meta_description.substring(0, 50) + '...' : '';

                return `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4 truncate max-w-xs text-sm font-medium text-white" title="${data.title}">${data.title || 'Untitled Product'}</td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-blue-400" title="${p.url}"><a href="${p.url}" target="_blank" class="hover:underline">${p.url}</a></td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showModalContent('${p.id}', 'existing')">
                            ${existingPreview || 'View Content'}
                        </td>
                        <td class="px-6 py-4">
                            <select onchange="handleProductAction('${p.id}', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded px-3 py-1.5 text-white min-w-[150px] focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer">
                                <option value="Idle" ${p.product_action === 'Idle' ? 'selected' : ''}>Idle</option>
                                <option value="Scrape Content" ${p.product_action === 'Scrape Content' ? 'selected' : ''}>Scrape Content</option>
                                <option value="Generate Content" ${p.product_action === 'Generate Content' ? 'selected' : ''}>Generate Content</option>
                                <option value="Generate MoFu" ${p.product_action === 'Generate MoFu' ? 'selected' : ''}>Generate MoFu</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showModalContent('${p.id}', 'new')">
                            ${contentPreview || '<span class="text-gray-600">Generate First</span>'}
                        </td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400 cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Meta Description', '${safeStr(data.meta_description)}')">
                            ${data.meta_description || '-'}
                        </td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400" title="${data.title}">${data.title || '-'}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function showResearchData(pageId) {
            const p = projectPages.find(page => page.id === pageId);
            if (!p || !p.research_data) {
                alert('No research data available for this topic.');
                return;
            }

            const researchData = p.research_data;

            // Helper to format mixed content (string, array, object)
            function formatResearchValue(val) {
                if (!val) return 'N/A';
                if (typeof val === 'string') return renderMarkdown(val);
                if (Array.isArray(val)) {
                    return `<ul class="list-disc list-inside space-y-1 ml-2">
                        ${val.map(item => `<li>${formatResearchValue(item)}</li>`).join('')}
                    </ul>`;
                }
                if (typeof val === 'object') {
                    return `<div class="space-y-2 ml-2 border-l-2 border-gray-700 pl-3">
                        ${Object.entries(val).map(([k, v]) => `
                            <div>
                                <span class="font-semibold text-gray-400 capitalize">${k.replace(/_/g, ' ')}:</span> 
                                <span class="text-gray-300">${formatResearchValue(v)}</span>
                            </div>
                        `).join('')}
                    </div>`;
                }
                return val;
            }

            // Format research data as readable HTML
            const formattedResearch = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-lg mb-2">Research Brief</h4>
                        <div class="text-gray-300 text-sm leading-relaxed">${renderMarkdown(researchData.brief || 'No brief available')}</div>
                    </div>
                    
                    ${researchData.search_intent ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Search Intent Analysis</h4>
                        <div class="text-gray-300 text-sm leading-relaxed">${renderMarkdown(researchData.search_intent)}</div>
                    </div>` : ''}
                    
                    ${researchData.key_subtopics ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Key Subtopics</h4>
                        <ul class="list-disc list-inside text-gray-300 space-y-1">
                            ${researchData.key_subtopics.map(topic => `<li>${renderMarkdown(topic)}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                    
                    ${researchData.competitor_analysis ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Competitor Content Strengths & Weaknesses</h4>
                        <div class="text-gray-300 text-sm leading-relaxed">
                            ${formatResearchValue(researchData.competitor_analysis)}
                        </div>
                    </div>` : ''}
                    
                    ${researchData.content_gaps ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Content Gaps</h4>
                        <div class="text-gray-300 text-sm leading-relaxed">
                            ${formatResearchValue(researchData.content_gaps)}
                        </div>
                    </div>` : ''}

                    
                    ${researchData.key_insights ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Key Insights, Statistics, and Data</h4>
                        <ul class="list-disc list-inside text-gray-300 space-y-1">
                            ${researchData.key_insights.map(insight => `<li>${renderMarkdown(insight)}</li>`).join('')}
                        </ul>
                    </div>` : ''
                }
                </div >
            `;

            document.getElementById('contentModalBody').innerHTML = formattedResearch;
            document.querySelector('#contentModal h3').innerText = 'Research Data';
            document.getElementById('contentModal').classList.remove('hidden');
            document.getElementById('contentModal').classList.add('flex');
        }

        function showTextModal(title, text) {
            document.getElementById('contentModalBody').innerHTML = `<div class="whitespace-pre-wrap text-gray-300 text-sm leading-relaxed">${renderMarkdown(text)}</div>`;
            document.querySelector('#contentModal h3').innerText = title;
            document.getElementById('contentModal').classList.remove('hidden');
            document.getElementById('contentModal').classList.add('flex');
        }

        function showModalContent(pageId, type) {
            const p = projectPages.find(page => page.id === pageId);
            if (!p) return;

            let content = '';
            let title = '';

            if (type === 'new') {
                content = p.content || 'No content generated yet.';
                title = 'Generated Content';
            } else {
                // Display the scraped body content
                content = p.tech_audit_data?.body_content || p.tech_audit_data?.meta_description || 'No existing content found. Click "Scrape Content" first.';
                title = 'Existing Content';
            }

            // Format content for better readability
            let formattedContent = content;

            // For existing content, add better structure
            if (type === 'existing') {
                formattedContent = content
                    // Add double line breaks before section headers (ALL CAPS lines)
                    .replace(/\n([A-Z][A-Z\s]+[A-Z])\n/g, '\n\n## $1\n\n')
                    // Convert bullet-like patterns to actual bullets
                    .replace(/\n-\s+/g, '\n ')
                    // Clean up excessive whitespace
                    .replace(/[ \t]+/g, ' ')
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();
            }

            // Render with proper line breaks and markdown
            const contentDiv = document.getElementById('contentModalBody');
            contentDiv.innerHTML = '';

            // Create a div for markdown content
            const div = document.createElement('div');
            div.className = 'whitespace-pre-wrap font-sans text-sm leading-relaxed text-gray-200 p-4';
            div.style.maxWidth = '100%';
            div.style.overflowWrap = 'break-word';
            div.innerHTML = renderMarkdown(formattedContent); // Use renderMarkdown here

            contentDiv.appendChild(div);

            document.querySelector('#contentModal h3').innerText = title;
            document.getElementById('contentModal').classList.remove('hidden');
            document.getElementById('contentModal').classList.add('flex');
        }

        async function handleProductAction(pageId, action) {
            if (action === 'Idle') return;

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                const apiAction = action === 'Scrape Content' ? 'scrape_content' :
                    action === 'Generate Content' ? 'generate_content' : 'generate_mofu';

                await fetch(`${API_BASE}/batch-update-pages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_ids: [pageId], action: apiAction })
                });
                await loadProject(currentProject.id);
            } catch (e) { alert(e); }
            finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        // --- View 4.5: Category Pages ---
        function renderCategoryPages() {
            const tbody = document.getElementById('categoryPagesTable');
            tbody.innerHTML = '';

            const categories = projectPages.filter(p => p.page_type === 'Category');

            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No Category pages found. Classify pages in "URL Classification" tab first.</td></tr>';
                return;
            }

            categories.forEach(p => {
                const data = p.tech_audit_data || {};
                const contentPreview = p.content ? p.content.substring(0, 50) + '...' : '';
                const existingPreview = p.tech_audit_data?.body_content ? p.tech_audit_data.body_content.substring(0, 50) + '...' : '';

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4 truncate max-w-xs text-sm font-medium text-white" title="${data.title}">${data.title || 'Untitled Category'}</td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-blue-400" title="${p.url}"><a href="${p.url}" target="_blank" class="hover:underline">${p.url}</a></td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showModalContent('${p.id}', 'existing')">
                            ${existingPreview || 'Scrape First'}
                        </td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400" title="${data.meta_description}">${data.meta_description || '-'}</td>
                        <td class="px-6 py-4">
                            <select onchange="handleCategoryAction('${p.id}', this.value)" class="bg-gray-800 border border-gray-700 text-xs rounded px-3 py-1.5 text-white min-w-[150px] focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer">
                                <option value="Idle" ${p.product_action === 'Idle' ? 'selected' : ''}>Idle</option>
                                <option value="Scrape Content" ${p.product_action === 'Scrape Content' ? 'selected' : ''}>Scrape Content</option>
                                <option value="Generate Content" ${p.product_action === 'Generate Content' ? 'selected' : ''}>Generate Content</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showModalContent('${p.id}', 'new')">
                            ${contentPreview || '<span class="text-gray-600">Generate First</span>'}
                        </td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400" title="${data.title}">${data.title || '-'}</td>
                    </tr>
                `;
            });
        }

        async function handleCategoryAction(pageId, action) {
            if (action === 'Idle') return;

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                const apiAction = action === 'Scrape Content' ? 'scrape_content' : 'generate_content';

                await fetch(`${API_BASE}/batch-update-pages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_ids: [pageId], action: apiAction })
                });
                await loadProject(currentProject.id);
            } catch (e) { alert(e); }
            finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        // --- View 5: MoFu ---
        function renderMoFu() {
            const tbody = document.getElementById('mofuTable');
            tbody.innerHTML = '';

            const topics = projectPages.filter(p => p.page_type === 'Topic' && p.funnel_stage === 'MoFu');

            if (topics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">No MoFu topics generated yet. Go to "Product / Pillars" and select "Generate MoFu".</td></tr>';
                return;
            }

            // Group by Source Page
            const grouped = {};
            topics.forEach(t => {
                const sourceId = t.source_page_id || 'unknown';
                if (!grouped[sourceId]) grouped[sourceId] = [];
                grouped[sourceId].push(t);
            });

            let htmlContent = '';
            for (const [sourceId, groupTopics] of Object.entries(grouped)) {
                const sourcePage = projectPages.find(p => p.id === sourceId);
                const sourceTitle = sourcePage ? (sourcePage.tech_audit_data?.title || sourcePage.url) : 'Unknown Source';

                // Header Row for Product
                htmlContent += `
                    <tr class="bg-gray-800/50 border-b border-gray-800">
                        <td colspan="9" class="px-6 py-3 text-xs font-bold text-gray-400 uppercase tracking-wider">
                            <i data-lucide="folder" class="w-3 h-3 inline mr-2"></i> ${sourceTitle} <span class="ml-2 text-gray-600">(${groupTopics.length})</span>
                        </td>
                    </tr>
                `;

                // Topic Rows
                htmlContent += groupTopics.map(t => {
                    const data = t.tech_audit_data || {};
                    const contentPreview = t.content ? t.content.substring(0, 30) + '...' : '';

                    // Helper to escape quotes for onclick
                    const safeStr = (str) => (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    return `
                        <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                            <td class="px-6 py-4 font-medium text-white text-sm pl-10 min-w-[350px]">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-3 h-3 text-gray-500 flex-shrink-0"></i>
                                    <span class="whitespace-normal leading-relaxed">${data.title || t.title || 'Untitled Topic'}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Content Description', '${safeStr(t.content_description)}')">
                                ${t.content_description || '-'}
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Keywords', '${safeStr(t.keywords)}')">
                                ${t.keywords || '-'}
                            </td>
                            <td class="px-6 py-4">
                                <select onchange="handleMoFuAction('${t.id}', this.value)" class="bg-gray-800 border-gray-700 text-xs rounded px-2 py-1 text-white w-full">
                                    <option value="Idle" ${t.product_action === 'Idle' ? 'selected' : ''}>Idle</option>
                                    <option value="Generate Content" ${t.product_action === 'Generate Content' ? 'selected' : ''}>Generate Content</option>
                                    <option value="Generate ToFu" ${t.product_action === 'Generate ToFu' ? 'selected' : ''}>Generate ToFu</option>
                                    <option value="PushWebflow" ${t.product_action === 'PushWebflow' ? 'selected' : ''}>PushWebflow</option>
                                </select>
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showResearchData('${t.id}')">
                                ${t.research_data ? '<span class="text-green-400 cursor-pointer hover:underline">View Research</span>' : '<span class="text-gray-600">-</span>'}
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showModalContent('${t.id}', 'new')">
                                ${contentPreview || '<span class="text-gray-600">-</span>'}
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Meta Title', '${safeStr(data.meta_title)}')">
                                ${data.meta_title || '-'}
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Meta Description', '${safeStr(data.meta_description)}')">
                                ${data.meta_description || '-'}
                            </td>
                            <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs" title="${t.slug}">${t.slug || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }
            tbody.innerHTML = htmlContent;
            lucide.createIcons();
        }

        async function handleMoFuAction(pageId, action) {
            if (action === 'Idle') return;

            if (action === 'PushWebflow') {
                alert("Push to Webflow is a placeholder for now.");
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                const apiAction = action === 'Generate Content' ? 'generate_content' :
                    action === 'Generate ToFu' ? 'generate_tofu' :
                        action === 'Generate Sub-Silo' ? 'generate_sub_silo' : 'idle';

                await fetch(`${API_BASE}/batch-update-pages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_ids: [pageId], action: apiAction })
                });
                await loadProject(currentProject.id);
            } catch (e) { alert(e); }
            finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        // --- View 6: ToFu ---
        function renderToFu() {
            const tbody = document.getElementById('tofuTable');
            tbody.innerHTML = '';

            const tofus = projectPages.filter(p => p.page_type === 'Topic' && p.funnel_stage === 'ToFu');

            if (tofus.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">No ToFu topics generated yet. Go to "MoFu / Silo Topics" and select "Generate ToFu".</td></tr>';
                return;
            }

            // Grouping: Product -> MoFu -> ToFu
            // 1. Group ToFus by MoFu ID
            const byMoFu = {};
            tofus.forEach(t => {
                const mofuId = t.source_page_id || 'unknown';
                if (!byMoFu[mofuId]) byMoFu[mofuId] = [];
                byMoFu[mofuId].push(t);
            });

            // 2. Group MoFus by Product ID
            const byProduct = {};
            Object.keys(byMoFu).forEach(mofuId => {
                const mofuPage = projectPages.find(p => p.id === mofuId);
                const productId = mofuPage ? mofuPage.source_page_id : 'unknown';

                if (!byProduct[productId]) byProduct[productId] = [];
                byProduct[productId].push({
                    mofu: mofuPage,
                    tofus: byMoFu[mofuId]
                });
            });

            // 3. Render
            for (const [productId, mofuGroups] of Object.entries(byProduct)) {
                const productPage = projectPages.find(p => p.id === productId);
                const productTitle = productPage ? (productPage.tech_audit_data?.title || productPage.url) : 'Unknown Product';

                // Level 1: Product Header
                tbody.innerHTML += `
                    <tr class="bg-gray-900 border-b border-gray-800">
                        <td colspan="9" class="px-6 py-3 text-sm font-bold text-white uppercase tracking-wider">
                            <i data-lucide="box" class="w-4 h-4 inline mr-2 text-blue-500"></i> ${productTitle}
                        </td>
                    </tr>
                `;

                mofuGroups.forEach(group => {
                    const mofuTitle = group.mofu ? (group.mofu.tech_audit_data?.title || group.mofu.content_description) : 'Unknown MoFu';

                    // Level 2: MoFu Header
                    tbody.innerHTML += `
                        <tr class="bg-gray-800/50 border-b border-gray-800">
                            <td colspan="9" class="px-6 py-2 text-xs font-medium text-gray-400 pl-12">
                                <i data-lucide="folder" class="w-3 h-3 inline mr-2 text-purple-400"></i> ${mofuTitle} <span class="ml-2 text-gray-600">(${group.tofus.length})</span>
                            </td>
                        </tr>
                    `;

                    // Level 3: ToFu Rows
                    group.tofus.forEach(t => {
                        const data = t.tech_audit_data || {};
                        const contentPreview = t.content ? t.content.substring(0, 30) + '...' : '';

                        // Helper to escape quotes for onclick
                        const safeStr = (str) => (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                        tbody.innerHTML += `
                            <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                                <td class="px-6 py-4 font-medium text-white text-sm pl-16 min-w-[350px]">
                                    <div class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 rounded-full bg-blue-500 flex-shrink-0"></span>
                                        <span class="whitespace-normal leading-relaxed">${data.title || t.title || 'Untitled Topic'}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Content Description', '${safeStr(t.content_description)}')">
                                    ${t.content_description || '-'}
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Keywords', '${safeStr(t.keywords)}')">
                                    ${t.keywords || '-'}
                                </td>
                                <td class="px-6 py-4">
                                    <select onchange="handleToFuAction('${t.id}', this.value)" class="bg-gray-800 border-gray-700 text-xs rounded px-2 py-1 text-white w-full">
                                        <option value="Idle" ${t.product_action === 'Idle' ? 'selected' : ''}>Idle</option>
                                        <option value="Generate Content" ${t.product_action === 'Generate Content' ? 'selected' : ''}>Generate Content</option>
                                        <option value="PushWebflow" ${t.product_action === 'PushWebflow' ? 'selected' : ''}>PushWebflow</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showResearchData('${t.id}')">
                                    ${t.research_data ? '<span class="text-green-400 cursor-pointer hover:underline">View Research</span>' : '<span class="text-gray-600">-</span>'}
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="showModalContent('${t.id}', 'new')">
                                    ${contentPreview || '<span class="text-gray-600">-</span>'}
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Meta Title', '${safeStr(data.meta_title)}')">
                                    ${data.meta_title || '-'}
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs cursor-pointer hover:text-white hover:underline" onclick="showTextModal('Meta Description', '${safeStr(data.meta_description)}')">
                                    ${data.meta_description || '-'}
                                </td>
                                <td class="px-6 py-4 text-xs text-gray-400 truncate max-w-xs" title="${t.slug}">${t.slug || '-'}</td>
                            </tr>
                        `;
                    });
                });
            }
            lucide.createIcons();
        }

        async function handleToFuAction(pageId, action) {
            if (action === 'Idle') return;

            if (action === 'PushWebflow') {
                alert("Push to Webflow is a placeholder for now.");
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                await fetch(`${API_BASE}/batch-update-pages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_ids: [pageId], action: 'generate_content' }) // Reusing generate_content
                });
                await loadProject(currentProject.id);
            } catch (e) { alert(e); }
            finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        // --- Modals ---
        function openNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('hidden');
            document.getElementById('newProjectModal').classList.add('flex');
        }
        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('hidden');
            document.getElementById('newProjectModal').classList.remove('flex');
        }
        async function createProject() {
            const domain = document.getElementById('newDomain').value;
            const language = document.getElementById('newLanguage').value;
            const location = document.getElementById('newLocation').value;
            const focus = document.getElementById('newFocus').value;

            if (!domain) {
                alert('Please enter a domain');
                return;
            }

            closeNewProjectModal();

            // Show loading
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');

            try {
                const res = await fetch(`${API_BASE}/create-project`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, language, location, focus })
                });
                const data = await res.json();

                // Reload projects list (refreshes dropdown)
                await loadProjectsList();

                // Show success message
                alert(` Project "${domain}" created successfully! Select it from the dropdown above.`);

                // Clear form
                document.getElementById('newDomain').value = '';
            } catch (e) {
                alert('Error creating project: ' + e.message);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

    </script>
    <script>
        // --- View 7: Product Photoshoot ---
        let photoshoots = [];

        async function loadPhotoshoots() {
            if (!currentProject) return;
            try {
                const res = await fetch(`${API_BASE}/photoshoots?project_id=${currentProject.id}`);
                photoshoots = await res.json();
                renderPhotoshoot();
            } catch (e) { console.error(e); }
        }

        function renderPhotoshoot() {
            const tbody = document.getElementById('photoshootTable');
            tbody.innerHTML = '';

            if (photoshoots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No photoshoot tasks. Click "Add Row" to start.</td></tr>';
                return;
            }

            photoshoots.forEach(item => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-900/50 transition-colors border-b border-gray-800/50">
                        <td class="px-6 py-4">
                            <input type="text" value="${item.prompt || ''}" 
                                onblur="updatePhotoshoot('${item.id}', 'prompt', this.value)"
                                class="bg-transparent border-none text-white w-full focus:ring-0 placeholder-gray-600" 
                                placeholder="Enter prompt...">
                        </td>
                        <td class="px-6 py-4">
                            <div class="relative w-16 h-16 bg-gray-800 rounded flex items-center justify-center overflow-hidden cursor-pointer group">
                                ${item.input_image_url ?
                        `<img src="${item.input_image_url}" class="w-full h-full object-cover">` :
                        `<i data-lucide="upload" class="w-6 h-6 text-gray-500"></i>`
                    }
                                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" 
                                    onchange="uploadPhotoshootImage('${item.id}', this.files[0])">
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs font-medium ${item.status === 'Done' ? 'bg-green-900/30 text-green-400' :
                        item.status === 'Error' ? 'bg-red-900/30 text-red-400' :
                            'bg-gray-800 text-gray-400'
                    }">${item.status || 'Todo'}</span>
                        </td>
                        <td class="px-6 py-4">
                            ${item.output_image_url ?
                        `<img src="${item.output_image_url}" class="w-16 h-16 object-cover rounded cursor-pointer" onclick="window.open('${item.output_image_url}', '_blank')">` :
                        `<span class="text-gray-600">-</span>`
                    }
                        </td>
                        <td class="px-6 py-4">
                            <select onchange="handlePhotoshootAction('${item.id}', this.value)" class="bg-gray-800 border-gray-700 text-xs rounded px-2 py-1 text-white w-full">
                                <option value="Idle" ${item.action === 'Idle' ? 'selected' : ''}>Idle</option>
                                <option value="Run" ${item.action === 'Run' ? 'selected' : ''}>Run</option>
                                <option value="Upscale" ${item.action === 'Upscale' ? 'selected' : ''}>Upscale</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="deletePhotoshoot('${item.id}')" class="text-gray-500 hover:text-red-400">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        async function addPhotoshootRow() {
            if (!currentProject) return;
            try {
                const res = await fetch(`${API_BASE}/photoshoots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        status: 'Todo',
                        action: 'Idle'
                    })
                });
                await loadPhotoshoots();
            } catch (e) { alert(e); }
        }

        async function updatePhotoshoot(id, field, value) {
            try {
                await fetch(`${API_BASE}/photoshoots/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
            } catch (e) { console.error(e); }
        }

        async function uploadPhotoshootImage(id, file) {
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.url) {
                    await updatePhotoshoot(id, 'input_image_url', data.url);
                    loadPhotoshoots();
                }
            } catch (e) { alert(e); }
        }

        async function handlePhotoshootAction(id, action) {
            if (action === 'Idle') return;
            await updatePhotoshoot(id, 'action', action);

            if (action === 'Run') {
                const item = photoshoots.find(p => p.id === id);
                if (!item.prompt) {
                    alert("Please enter a prompt first.");
                    return;
                }
                const row = photoshoots.find(p => p.id === id);
                if (row) row.status = 'Processing...';
                renderPhotoshoot();

                try {
                    const res = await fetch(`${API_BASE}/generate-image`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: item.prompt,
                            input_image_url: item.input_image_url
                        })
                    });
                    const data = await res.json();
                    await fetch(`${API_BASE}/photoshoots/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            output_image_url: data.output_image_url,
                            status: 'Done',
                            action: 'Idle'
                        })
                    });
                    loadPhotoshoots();
                } catch (e) {
                    alert(e);
                    await updatePhotoshoot(id, 'status', 'Error');
                    loadPhotoshoots();
                }
            }
        }

        async function deletePhotoshoot(id) {
            if (!confirm("Delete this task?")) return;
            try {
                await fetch(`${API_BASE}/photoshoots/${id}`, { method: 'DELETE' });
                loadPhotoshoots();
            } catch (e) { alert(e); }
        }
    </script>
</body>

</html>