-- FINAL DATABASE HANDOVER
-- Run this in your Supabase SQL Editor to ensure your database is up to date.

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "vector";

-- 1. Projects Table
CREATE TABLE IF NOT EXISTS projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_id UUID -- Optional, for future auth
);

-- 2. Profiles Table (ICP / Business Context)
CREATE TABLE IF NOT EXISTS business_profiles (
    id UUID PRIMARY KEY REFERENCES projects(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    business_summary TEXT,
    target_audience TEXT,
    ideal_customer_profile TEXT,
    brand_voice TEXT,
    competitors JSONB,
    primary_products JSONB,
    unique_selling_points TEXT[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Pages Table (The Core "Brain")
CREATE TABLE IF NOT EXISTS pages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    url TEXT NOT NULL,
    page_type TEXT, -- 'Landing Page', 'Blog Post', 'Topic', 'Silo'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Tech Audit Data
    tech_audit_data JSONB,
    
    -- Content Audit Data
    content_audit_data JSONB,
    
    -- Approval Workflow
    approval_status BOOLEAN DEFAULT FALSE,
    status TEXT DEFAULT 'Draft', -- 'Draft', 'Published'
    
    -- Content Strategy & Funnel
    funnel_stage TEXT, -- 'MoFu', 'ToFu', etc.
    source_page_id UUID,
    content_description TEXT,
    keywords TEXT,
    product_action TEXT,
    
    -- Research & Generation
    research_data JSONB,
    content TEXT,
    slug TEXT,
    
    -- Image Generation (NEW)
    image_prompt TEXT,
    main_image_url TEXT
);

-- 4. Content Briefs Table
CREATE TABLE IF NOT EXISTS content_briefs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    page_id UUID REFERENCES pages(id) ON DELETE CASCADE,
    brief_data JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. Photoshoots Table (For Manual Image Gen)
CREATE TABLE IF NOT EXISTS photoshoots (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    name TEXT,
    status TEXT DEFAULT 'pending', -- 'pending', 'Processing', 'Done', 'Failed'
    input_image TEXT, -- URL or path
    output_image TEXT, -- URL or path (Public Supabase URL)
    prompt TEXT,
    aspect_ratio TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 6. Storage Bucket for Photoshoots
-- IMPORTANT: If this fails, create the bucket manually in the Supabase Dashboard.
-- Go to Storage -> New Bucket -> Name: "photoshoots" -> Make Public: YES.

INSERT INTO storage.buckets (id, name, public) 
VALUES ('photoshoots', 'photoshoots', true)
ON CONFLICT (id) DO NOTHING;

-- Storage Policies (Allow public access)
-- You may need to run these separately if you encounter errors.
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING (bucket_id = 'photoshoots');
CREATE POLICY "Public Insert" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'photoshoots');
CREATE POLICY "Public Update" ON storage.objects FOR UPDATE USING (bucket_id = 'photoshoots');
CREATE POLICY "Public Delete" ON storage.objects FOR DELETE USING (bucket_id = 'photoshoots');
